name: ğŸš€ Release Pipeline

on:
  push:
    tags: ['v*']
  
  # Allow manual releases
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v2.8.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  # Pre-flight validation
  validate:
    name: ğŸ” Pre-flight Validation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      
      - name: ğŸ—ï¸ Build project
        run: npm run build
      
      - name: ğŸ§ª Run full test suite
        run: |
          npm run test
          npm run test:audit
      
      - name: ğŸ”§ ESLint validation
        run: npm run lint
      
      - name: ğŸ¯ Extract version info
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            # Detect pre-release from tag (contains alpha, beta, rc)
            if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          echo "ğŸ·ï¸ Version: $VERSION"
          echo "ğŸ§ª Pre-release: $IS_PRERELEASE"

  # Cross-platform testing
  test-matrix:
    name: ğŸ§ª Cross-Platform Testing
    needs: validate
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['18', '20', '22']
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v6
      
      - name: âš¡ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      
      - name: ğŸ—ï¸ Build project
        run: npm run build
      
      - name: ğŸ§ª Run tests
        run: npm test
      
      - name: ğŸ¯ Test CLI functionality
        run: |
          # Test basic CLI commands
          node dist/cli.js --version
          node dist/cli.js --help

  # Build release artifacts
  build-artifacts:
    name: ğŸ—ï¸ Build Release Artifacts
    needs: [validate, test-matrix]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v6
      
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      
      - name: ğŸ—ï¸ Build project
        run: npm run build
      
      - name: ğŸ“¦ Create package
        run: npm pack
      
      - name: ğŸ“Š Package info
        run: |
          echo "ğŸ·ï¸ Package created:"
          ls -la *.tgz
          
          echo "ğŸ“¦ Package contents:"
          tar -tzf *.tgz | head -20
      
      - name: ğŸ’¾ Upload package artifact
        uses: actions/upload-artifact@v6
        with:
          name: npm-package
          path: '*.tgz'
          retention-days: 30

  # Generate changelog
  changelog:
    name: ğŸ“ Generate Changelog
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: ğŸ“ Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [[ -n "$LAST_TAG" ]]; then
            echo "ğŸ“… Changes since $LAST_TAG:"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $LAST_TAG..HEAD)
          else
            echo "ğŸ“… Initial release - all commits:"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --max-count=20)
          fi
          
          # Save multiline output safely
          {
            echo 'changelog<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

  # Publish to NPM
  publish-npm:
    name: ğŸ“¢ Publish to NPM
    needs: [validate, test-matrix, build-artifacts, changelog]
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v6
      
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      
      - name: ğŸ—ï¸ Build project
        run: npm run build
      
      - name: ğŸ” Verify package before publish
        run: |
          echo "ğŸ” Verifying package integrity..."
          npm pack --dry-run
          
          echo "ğŸ“‹ Package details:"
          npm info @faf/cli --json | jq '.versions[-5:]'
      
      - name: ğŸ“¢ Publish to NPM
        run: |
          if [[ "${{ needs.validate.outputs.is-prerelease }}" == "true" ]]; then
            echo "ğŸ§ª Publishing pre-release to NPM..."
            npm publish --tag beta --access public
          else
            echo "ğŸš€ Publishing stable release to NPM..."
            npm publish --access public
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: ğŸ‰ NPM publish success
        run: |
          echo "âœ… Successfully published @faf/cli@${{ needs.validate.outputs.version }}"
          echo "ğŸ“¦ Available at: https://www.npmjs.com/package/@faf/cli"
          echo "ğŸ’» Install with: npm install -g @faf/cli"

  # Create GitHub release
  github-release:
    name: ğŸ·ï¸ Create GitHub Release
    needs: [validate, test-matrix, build-artifacts, changelog, publish-npm]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v6
      
      - name: ğŸ’¾ Download package artifact
        uses: actions/download-artifact@v7
        with:
          name: npm-package
      
      - name: ğŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: FAF CLI ${{ needs.validate.outputs.version }}
          body: |
            # ğŸï¸ FAF CLI ${{ needs.validate.outputs.version }}

            **F1-Inspired Software Engineering** - Making AI development better for everyone! ğŸ

            ## ğŸš€ Installation

            ```bash
            npm install -g @faf/cli@${{ needs.validate.outputs.version }}
            ```

            ## ğŸ“‹ Changes

            ${{ needs.changelog.outputs.changelog }}

            ## ğŸ¯ Quick Start

            ```bash
            # Create .faf file for your project
            faf init

            # Check your AI context score
            faf score --details

            # Build trust with AI
            faf trust
            ```

            ## ğŸ“Š Performance Metrics

            - âš¡ Status command: <40ms (F1-inspired speed)
            - ğŸ¯ Trust calculation: <200ms
            - ğŸ’ Technical credit system active
            - ğŸ† Championship-grade engineering

            ## ğŸ”— Links

            - ğŸ“¦ [NPM Package](https://www.npmjs.com/package/@faf/cli)
            - ğŸ“š [Documentation](https://docs.faf.one)
            - ğŸ› [Report Issues](https://github.com/faf-org/cli/issues)
            - ğŸ’¬ [Discussions](https://github.com/faf-org/cli/discussions)

            ---

            **ğŸ Trust-driven development starts here!**
          draft: false
          prerelease: ${{ needs.validate.outputs.is-prerelease == 'true' }}
          files: |
            *.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Performance benchmarks
  performance-benchmark:
    name: âš¡ Performance Validation
    needs: [validate, publish-npm]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v6
      
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ“¥ Install published package
        run: |
          echo "ğŸ”„ Installing published version..."
          npm install -g @faf/cli@${{ needs.validate.outputs.version }}
          faf --version
      
      - name: ğŸï¸ F1-Inspired Performance Tests
        run: |
          echo "âš¡ Testing championship performance claims..."
          
          # Test status command speed (<40ms target)
          echo "ğŸ¯ Testing 'faf status' speed..."
          time faf status || echo "No .faf file found (expected)"
          
          # Test help command speed
          echo "ğŸ“š Testing 'faf --help' speed..."
          time faf --help
          
          # Test index command speed
          echo "ğŸ“‹ Testing 'faf index' speed..."
          time faf index
          
          echo "âœ… Performance validation complete!"

  # Notification
  notify-success:
    name: ğŸ‰ Success Notification
    needs: [validate, test-matrix, build-artifacts, publish-npm, github-release, performance-benchmark]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: ğŸ† Championship Success!
        run: |
          echo "ğŸ ğŸï¸ FAF CLI ${{ needs.validate.outputs.version }} RELEASED! âš¡ğŸ†"
          echo ""
          echo "âœ… All systems green - Championship engineering delivered!"
          echo "ğŸš€ NPM: Published and ready"
          echo "ğŸ·ï¸ GitHub: Release created"
          echo "âš¡ Performance: F1-validated"
          echo "ğŸ“Š Analytics: Tracking enabled"
          echo ""
          echo "ğŸ¯ Trust-driven development is now available to everyone!"
          echo "ğŸ“¦ Install: npm install -g @faf/cli@${{ needs.validate.outputs.version }}"

  # Failure notification
  notify-failure:
    name: ğŸš¨ Failure Notification
    needs: [validate, test-matrix, build-artifacts, publish-npm, github-release]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: ğŸš¨ Release Failed
        run: |
          echo "âŒ FAF CLI ${{ needs.validate.outputs.version }} release failed!"
          echo "ğŸ”§ Check the workflow logs for details"
          echo "ğŸï¸ F1-inspired engineering demands perfection - we'll fix this!"