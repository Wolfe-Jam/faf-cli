name: ğŸ“¢ Discord Release Announcement

on:
  release:
    types: [published]

jobs:
  announce-discord:
    name: ğŸ“¢ Announce to Discord
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Extract release info
        id: release
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          RELEASE_NAME="${{ github.event.release.name }}"
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
          RELEASE_URL="${{ github.event.release.html_url }}"

          # Get first 10 lines of changelog (Discord has char limits)
          CHANGELOG=$(echo "${{ github.event.release.body }}" | grep "^- " | head -10)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "url=$RELEASE_URL" >> $GITHUB_OUTPUT

          # Save changelog safely for multiline
          {
            echo 'changelog<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: ğŸš€ Announce to Discord
        run: |
          # Determine emoji based on release type
          if [[ "${{ steps.release.outputs.prerelease }}" == "true" ]]; then
            EMOJI="ğŸ”§"
            TYPE="Beta Release"
          else
            EMOJI="ğŸï¸"
            TYPE="New Release"
          fi

          # Format the Discord message
          DISCORD_MESSAGE=$(cat <<EOF
          {
            "content": null,
            "embeds": [{
              "title": "$EMOJI FAF CLI ${{ steps.release.outputs.version }}",
              "description": "**$TYPE** - IANA format-driven persistent project context for AI",
              "color": 16753920,
              "fields": [
                {
                  "name": "âœ¨ Highlights",
                  "value": "${{ steps.release.outputs.name }}",
                  "inline": false
                },
                {
                  "name": "ğŸ“¦ Install",
                  "value": "\`\`\`bash\nnpm install -g faf-cli@${{ steps.release.outputs.version }}\n\`\`\`\n\`\`\`bash\nbrew install faf-cli\n\`\`\`",
                  "inline": false
                },
                {
                  "name": "ğŸ“‹ What Changed",
                  "value": "${{ steps.release.outputs.changelog }}",
                  "inline": false
                },
                {
                  "name": "ğŸ”— Links",
                  "value": "[faf.one](https://faf.one) | [Discord Community](https://discord.com/invite/3pjzpKsP) | [npm download](https://www.npmjs.com/package/faf-cli)",
                  "inline": false
                }
              ],
              "footer": {
                "text": "IANA-Registered AI Context Standard"
              },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          )

          # Send to Discord webhook
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$DISCORD_MESSAGE" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

          echo "âœ… Discord announcement sent!"

      - name: ğŸ‰ Success
        run: |
          echo "ğŸ“¢ Discord community notified of ${{ steps.release.outputs.version }}"
          echo "ğŸ Release announcement complete!"
