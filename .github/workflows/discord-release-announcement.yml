name: ğŸ“¢ Discord Release Announcement

on:
  release:
    types: [published]

jobs:
  announce-discord:
    name: ğŸ“¢ Announce to Discord
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Extract release info
        id: release
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          RELEASE_NAME="${{ github.event.release.name }}"
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
          RELEASE_URL="${{ github.event.release.html_url }}"

          # Get first 10 lines of changelog (Discord has char limits)
          CHANGELOG=$(echo "${{ github.event.release.body }}" | grep "^- " | head -10)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "url=$RELEASE_URL" >> $GITHUB_OUTPUT

          # Save changelog safely for multiline
          {
            echo 'changelog<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: ğŸš€ Announce to Discord
        run: |
          # Determine emoji based on release type
          if [[ "${{ steps.release.outputs.prerelease }}" == "true" ]]; then
            EMOJI="ğŸ”§"
            TYPE="Beta Release"
          else
            EMOJI="âš¡ï¸"
            TYPE="New Release"
          fi

          # Format the Discord message
          DISCORD_MESSAGE=$(cat <<EOF
          {
            "content": null,
            "embeds": [{
              "title": "$EMOJI FAF CLI ${{ steps.release.outputs.version }}",
              "description": "**$TYPE** - IANA format-driven persistent project context for AI",
              "color": 16753920,
              "fields": [
                {
                  "name": "âœ¨ Highlights",
                  "value": "${{ steps.release.outputs.name }}",
                  "inline": false
                },
                {
                  "name": "ğŸ“¦ Install",
                  "value": "`npm install -g faf-cli@${{ steps.release.outputs.version }}`\n\n`brew install faf-cli`",
                  "inline": false
                },
                {
                  "name": "ğŸ“‹ What Changed",
                  "value": "${{ steps.release.outputs.changelog }}",
                  "inline": false
                },
                {
                  "name": "ğŸ”— Links",
                  "value": "[faf.one](https://faf.one) | [Discord Community](https://discord.com/invite/56fPBUJKfk) | [npm download](https://www.npmjs.com/package/faf-cli)",
                  "inline": false
                }
              ],
              "footer": {
                "text": "IANA-Registered AI Context Standard"
              },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          )

          # Send to Discord webhook
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$DISCORD_MESSAGE" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

          echo "âœ… Discord announcement sent!"

      - name: ğŸŒ Update releases.json
        run: |
          # Create release JSON object
          RELEASE_JSON=$(cat <<EOF
          {
            "version": "${{ steps.release.outputs.version }}",
            "name": "${{ steps.release.outputs.name }}",
            "date": "$(date -u +%Y-%m-%d)",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
            "prerelease": ${{ steps.release.outputs.prerelease }},
            "changelog": $(echo "${{ steps.release.outputs.changelog }}" | jq -Rs .),
            "urls": {
              "github": "${{ steps.release.outputs.url }}",
              "npm": "https://www.npmjs.com/package/faf-cli/v/${{ steps.release.outputs.version }}",
              "discord": "https://discord.com/invite/56fPBUJKfk"
            },
            "install": {
              "npm": "npm install -g faf-cli@${{ steps.release.outputs.version }}",
              "brew": "brew install faf-cli"
            }
          }
          EOF
          )

          # Prepend to releases.json (newest first)
          jq --argjson new "$RELEASE_JSON" '. = [$new] + .' website/releases.json > website/releases.tmp.json
          mv website/releases.tmp.json website/releases.json

          # Show the update
          echo "ğŸ“ Updated releases.json:"
          jq '.[0]' website/releases.json

      - name: ğŸ“¤ Commit releases.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add website/releases.json
          git commit -m "chore: add ${{ steps.release.outputs.version }} to releases.json

Release: ${{ steps.release.outputs.name }}
Date: $(date -u +%Y-%m-%d)
Automated by GitHub Actions"

          git push

          echo "âœ… releases.json updated and committed!"

      - name: ğŸ‰ Success
        run: |
          echo "ğŸ“¢ Discord community notified of ${{ steps.release.outputs.version }}"
          echo "ğŸŒ releases.json updated at https://raw.githubusercontent.com/Wolfe-Jam/faf-cli/main/website/releases.json"
          echo "ğŸ Release announcement complete!"
